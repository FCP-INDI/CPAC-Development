# This script takes a tag ($TAG) from https://hub.docker.com/repository/docker/fcpindi/c-pac/tags, and does the following:
#   1. recreates an image with the same contents as ${TAG}-DEPRECATED except also printing the text in `CRITICAL_ALERT.rst` when the image is run and adding a copy to the log directory of each run generated by the image,
#   2. replaces that tag with an image that only prints the text in `CRITICAL_ALERT.rst`, and
#   3. pushes both images to Docker Hub, overwriting any existing images with the same name.
#
# Usage: ./rebuild_and_deprecate $DEPRECATED_TAG

if [[ $# != 1 ]]
then
  head -n 6 $(basename "$0")
  exit 0
fi

export DEPRECATED_TAG=$1
docker pull fcpindi/c-pac:${DEPRECATED_TAG}
docker build -t fcpindi/c-pac:${DEPRECATED_TAG}-DEPRECATED --build-arg DEPRECATED_VERSION=${DEPRECATED_TAG} -f redeprecate.Dockerfile .
docker build -t fcpindi/c-pac:${DEPRECATED_TAG} -f DEPRECATED.Dockerfile --build-arg DEPRECATED_VERSION=${DEPRECATED_TAG} .
docker push fcpindi/c-pac:${DEPRECATED_TAG}-DEPRECATED
docker push fcpindi/c-pac:${DEPRECATED_TAG}
