# This script takes a tag ($TAG) from https://hub.docker.com/repository/docker/fcpindi/c-pac/tags, and does the following:
#   1. recreates an image with the same contents as ${TAG}-DEPRECATED except also printing the text in `CRITICAL_ALERT.rst` when the image is run and adding a copy to the log directory of each run generated by the image,
#   2. replaces that tag with an image that only prints the text in `CRITICAL_ALERT.rst`, and
#   3. pushes both images to Docker Hub, overwriting any existing images with the same name.
#
# Usage: ./rebuild_and_deprecate $DEPRECATED_TAG $RECOMMENDED_MINIMUM_VERSION
#
# Copyright (C) 2022  C-PAC Developers

# This file is part of CPAC-Development.

# CPAC-Development is free software: you can redistribute it and/or modify it under the terms of the GNU Lesser General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

# CPAC-Development is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.

# You should have received a copy of the GNU Lesser General Public License along with CPAC-Development. If not, see <https://www.gnu.org/licenses/>.

if [[ $# != 2 ]]
then
  head -n 6 $(basename "$0")
  exit 0
fi

export DEPRECATED_TAG=$1
export RECOMMENDED_MINIMUM_VERSION=$2
docker pull fcpindi/c-pac:${DEPRECATED_TAG}-DEPRECATED
docker build -t fcpindi/c-pac:${DEPRECATED_TAG}-DEPRECATED --build-arg DEPRECATED_VERSION=${DEPRECATED_TAG} --build-arg RECOMMENDED_MINIMUM_VERSION=${RECOMMENDED_MINIMUM_VERSION} -f redeprecate.Dockerfile .
docker build -t fcpindi/c-pac:${DEPRECATED_TAG} -f DEPRECATED.Dockerfile --build-arg DEPRECATED_VERSION=${DEPRECATED_TAG} --build-arg RECOMMENDED_MINIMUM_VERSION=${RECOMMENDED_MINIMUM_VERSION} .
# docker push fcpindi/c-pac:${DEPRECATED_TAG}-DEPRECATED
# docker push fcpindi/c-pac:${DEPRECATED_TAG}
